<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Postular a oferta | Taxi Confianza</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tus estilos -->
  <link rel="stylesheet" href="styles.css" />
<link rel="stylesheet" href="css/dashboard-theme.css" />


  <style>
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }
    .card {
      background: var(--card-bg, #111);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 14px;
    }
    textarea {
      min-height: 120px;
      resize: vertical;
    }
    .actions {
      display: flex;
      gap: 12px;
      margin-top: 18px;
    }
    .alert {
      margin-top: 15px;
      padding: 12px;
      border-radius: 10px;
      display: none;
    }
    .alert.success { background: #103d1a; color: #7dff9a; }
    .alert.error { background: #3d1010; color: #ff8a8a; }
  </style>
  <style>
  body{
    background: var(--bg, #0b1220);
    color: var(--text, #e7eefc);
  }
  .card{
    background: var(--card, rgba(255,255,255,.06));
    border: 1px solid var(--border, rgba(255,255,255,.12));
    box-shadow: 0 10px 30px rgba(0,0,0,.25);
  }
  .muted{ color: var(--muted, rgba(231,238,252,.72)); }

  /* inputs */
  .input, textarea{
    background: var(--input, rgba(255,255,255,.06));
    color: var(--text, #e7eefc);
    border: 1px solid var(--border, rgba(255,255,255,.12));
    border-radius: 12px;
    padding: 10px 12px;
    outline: none;
  }
  .input:focus, textarea:focus{
    border-color: var(--accent, #f5c542);
    box-shadow: 0 0 0 3px rgba(245,197,66,.20);
  }

  /* botones si no existen en tu theme */
  .btn{ display:inline-flex; align-items:center; justify-content:center; padding:10px 14px; border-radius:12px; border:1px solid transparent; cursor:pointer; text-decoration:none; }
  .btn-primary{ background: var(--accent, #f5c542); color:#111; font-weight:700; }
  .btn-ghost{ background: transparent; border-color: var(--border, rgba(255,255,255,.12)); color: var(--text, #e7eefc); }

  /* alertas */
  .alert.success{ background: rgba(34,197,94,.15); color: #bbf7d0; border: 1px solid rgba(34,197,94,.35); }
  .alert.error{ background: rgba(239,68,68,.15); color: #fecaca; border: 1px solid rgba(239,68,68,.35); }
</style>

</head>

<body>

  <div class="container">

    <h1>Postular a oferta</h1>
    <p class="muted">Completa el formulario para enviar tu postulación.</p>

    <!-- ========================= -->
    <!-- DETALLE DE LA OFERTA -->
    <!-- ========================= -->
    <div class="card" id="ofertaCard">
      <h2 id="ofertaTitulo">Cargando oferta...</h2>
      <p id="ofertaDescripcion"></p>

      <p class="muted" id="ofertaMeta"></p>
    </div>

    <!-- ========================= -->
    <!-- FORMULARIO POSTULACIÓN -->
    <!-- ========================= -->
    <div class="card">

      <div class="field">
        <label class="label" for="mensaje">Mensaje para el propietario *</label>
        <textarea
          id="mensaje"
          class="input"
          maxlength="1500"
          placeholder="Ej: Tengo experiencia, disponibilidad inmediata, conozco la ciudad..."
        ></textarea>
      </div>

      <!-- ✅ INPUT CV -->
      <div class="field">
        <label class="label" for="cv_url">Link CV (opcional)</label>
        <input
          id="cv_url"
          class="input"
          maxlength="255"
          placeholder="https://drive.google.com/..."
        />
      </div>

      <div class="actions">
        <button id="btnPostular" class="btn btn-primary">
          Postular
        </button>
        <a href="conductor-ofertas.html" class="btn btn-ghost">
          Volver
        </a>
      </div>

      <div id="successBox" class="alert success"></div>
      <div id="errorBox" class="alert error"></div>
    </div>

  </div>

  <!-- ========================= -->
  <!-- JS -->
  <!-- ========================= -->
  <script>
    const params = new URLSearchParams(window.location.search);
    const ofertaId = params.get("id");

    const ofertaTitulo = document.getElementById("ofertaTitulo");
    const ofertaDescripcion = document.getElementById("ofertaDescripcion");
    const ofertaMeta = document.getElementById("ofertaMeta");

    const mensajeInput = document.getElementById("mensaje");
    const cvUrlInput = document.getElementById("cv_url");

    const btnPostular = document.getElementById("btnPostular");
    const successBox = document.getElementById("successBox");
    const errorBox = document.getElementById("errorBox");

    if (!ofertaId) {
      ofertaTitulo.textContent = "Error";
      ofertaDescripcion.textContent = "No se indicó la oferta.";
      btnPostular.disabled = true;
    } else {
      cargarOferta();
    }

    // =========================
    // CARGAR OFERTA
    // =========================
    async function cargarOferta() {
      try {
        const r = await fetch(`/api/ofertas-trabajo/${ofertaId}`, {
          credentials: "include"
        });
        const data = await r.json();

        if (!data.ok) throw new Error(data.error || "No se pudo cargar la oferta");

        const o = data.oferta;

        ofertaTitulo.textContent = o.titulo;
        ofertaDescripcion.textContent = o.descripcion || "";

        ofertaMeta.textContent = `
          Ciudad: ${o.ciudad || "-"} ·
          Turno: ${o.turno || "-"} ·
          Cuota diaria: ${o.cuota_diaria || "-"}
        `;
      } catch (err) {
        ofertaTitulo.textContent = "Error";
        ofertaDescripcion.textContent = err.message;
        btnPostular.disabled = true;
      }
    }

    // =========================
    // POSTULAR
    // =========================
    btnPostular.addEventListener("click", async () => {
      successBox.style.display = "none";
      errorBox.style.display = "none";

      const mensaje = mensajeInput.value.trim();
      const cv_url = cvUrlInput.value.trim();

      if (!mensaje) {
        errorBox.textContent = "Debes escribir un mensaje.";
        errorBox.style.display = "block";
        return;
      }

      btnPostular.disabled = true;
      btnPostular.textContent = "Enviando...";

      try {
        const r2 = await fetch(`/api/ofertas-trabajo/${ofertaId}/postular`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({
            mensaje,
            cv_url
          })
        });

        const data2 = await r2.json();
        if (!data2.ok) throw new Error(data2.error || "Error al postular");

        successBox.textContent = "✅ Postulación enviada correctamente (pendiente)";
        successBox.style.display = "block";

        btnPostular.textContent = "Postulado";
      } catch (err) {
        errorBox.textContent = err.message;
        errorBox.style.display = "block";
        btnPostular.disabled = false;
        btnPostular.textContent = "Postular";
      }
    });
  </script>

</body>
</html>


