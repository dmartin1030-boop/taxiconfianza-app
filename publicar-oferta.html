<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Publicar oferta | Taxi Confianza</title>

  <!-- Usa tu css actual -->
  <link rel="stylesheet" href="/css/dashboard.css" />
</head>

<body>
  <!-- ✅ 1) Contenedor principal: sidebar + main -->
  <div class="layout">

    <!-- ✅ 2) SIDEBAR -->
    <aside class="sidebar">
      <nav class="nav" aria-label="Navegación del propietario">

        <a class="active" href="/dashboard-propietario.html" aria-current="page">
          <svg class="ico" viewBox="0 0 24 24" fill="none">
            <path d="M4 10.5L12 4l8 6.5V20a1.5 1.5 0 0 1-1.5 1.5H5.5A1.5 1.5 0 0 1 4 20v-9.5Z"
              stroke="currentColor" stroke-width="1.6"/>
          </svg>
          Dashboard
        </a>

        <!-- ✅ Botón con icono -->
        <a href="/publicar-oferta.html" class="nav-cta">
          <svg class="ico" viewBox="0 0 24 24" fill="none">
            <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
          Publicar oferta
        </a>

        <a href="/mis-ofertas.html">
          <svg class="ico" viewBox="0 0 24 24" fill="none">
            <path d="M4 7h16M4 12h16M4 17h10" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
          Mis ofertas
        </a>

        <a href="/postulaciones-propietario.html">
          <svg class="ico" viewBox="0 0 24 24" fill="none">
            <path d="M7 8h10M7 12h10M7 16h6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
            <path d="M5 4h14v16H5z" stroke="currentColor" stroke-width="1.6"/>
          </svg>
          Postulaciones
        </a>

        <a href="/trabajo-actual.html">
          <svg class="ico" viewBox="0 0 24 24" fill="none">
            <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
            <path d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="1.6"/>
          </svg>
          Trabajo actual
        </a>

        <a href="/historial-trabajos.html">
          <svg class="ico" viewBox="0 0 24 24" fill="none">
            <path d="M7 4h10v4H7z" stroke="currentColor" stroke-width="1.6"/>
            <path d="M6 8h12v12H6z" stroke="currentColor" stroke-width="1.6"/>
            <path d="M8 12h8M8 16h6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
          Historial de trabajos
        </a>

      </nav>
    </aside>

    <!-- ✅ 3) MAIN (todo tu contenido va aquí adentro) -->
    <main class="main">

      <!-- ✅ 4) Contenedor interno para que no se “pegue” al borde -->
      <div class="container">

        <header class="page-header">
          <h1>Publicar oferta</h1>
          <p class="muted">Crea una oferta para que los conductores se postulen.</p>
        </header>

        <!-- CARD: FORM -->
        <section class="card">
          <div class="card-head">
            <h2>Nueva oferta</h2>
            <p class="muted">Se guarda en <b>ofertas_trabajo</b>.</p>
          </div>

          <form id="formOferta" class="form-grid">

            <div class="field">
              <label for="vehiculo_id">Vehículo</label>
              <select id="vehiculo_id" name="vehiculo_id" required>
                <option value="">Cargando…</option>
              </select>
            </div>

            <div class="field">
              <label for="ciudad">Ciudad</label>
              <input id="ciudad" name="ciudad" type="text" placeholder="Ej: Bogotá" required />
            </div>

            <div class="field">
              <label for="turno">Turno</label>
              <select id="turno" name="turno">
                <option value="dia">Día</option>
                <option value="noche">Noche</option>
                <option value="mixto">Mixto</option>
              </select>
            </div>

            <div class="field">
              <label for="estado">Estado</label>
              <select id="estado" name="estado">
                <option value="activa" selected>Activa</option>
                <option value="pausada">Pausada</option>
                <option value="cerrada">Cerrada</option>
              </select>
            </div>

            <div class="field field-full">
              <label for="titulo">Título</label>
              <input id="titulo" name="titulo" type="text" placeholder="Ej: Taxi turno noche con pago diario" required />
            </div>

            <div class="field field-full">
              <label for="descripcion">Descripción</label>
              <textarea id="descripcion" name="descripcion" rows="4" placeholder="Describe condiciones, horarios, zonas, etc."></textarea>
            </div>

            <div class="field">
              <label for="cuota_diaria">Cuota diaria ($)</label>
              <input id="cuota_diaria" name="cuota_diaria" type="number" min="0" step="1" placeholder="Ej: 70000" />
            </div>

            <div class="field">
              <label for="porcentaje_propietario">% para propietario</label>
              <input id="porcentaje_propietario" name="porcentaje_propietario" type="number" min="0" step="0.01" placeholder="Ej: 30.00" />
            </div>

            <div class="field field-full">
              <small class="muted">Debes llenar <b>cuota diaria</b> o <b>% propietario</b> (al menos uno).</small>
            </div>

            <div class="field field-full">
              <label for="requisitos">Requisitos</label>
              <textarea id="requisitos" name="requisitos" rows="3" placeholder="Ej: licencia vigente, sin comparendos, experiencia 1 año."></textarea>
            </div>

            <div class="actions">
              <button type="submit" class="btn-primary" id="btnPublicar">Publicar oferta</button>
              <button type="button" class="btn-ghost" id="btnLimpiar">Limpiar</button>
            </div>

          </form>
        </section>

        <!-- CARD: MIS OFERTAS -->
        <section class="card">
          <div class="card-head row-between">
            <div>
              <h2>Mis ofertas</h2>
              <p class="muted">Gestiona estado o elimina (soft delete).</p>
            </div>
            <button class="btn-ghost" id="btnRefrescar" type="button">Refrescar</button>
          </div>

          <div class="table-wrap">
            <table class="table" id="tablaOfertas">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Título</th>
                  <th>Ciudad</th>
                  <th>Turno</th>
                  <th>Pago</th>
                  <th>Estado</th>
                  <th>Bloqueada</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr><td colspan="8" class="muted">Cargando…</td></tr>
              </tbody>
            </table>
          </div>
        </section>

      </div><!-- /container -->
    </main>
  </div><!-- /layout -->

  <script>
    const API = {
      vehiculos: "/api/propietario/vehiculos",
      crearOferta: "/api/ofertas",
      misOfertas: "/api/propietario/ofertas",
      actualizarOferta: (id) => `/api/ofertas/${id}`,
      eliminarOferta: (id) => `/api/ofertas/${id}`,
    };

    const $ = (s) => document.querySelector(s);

    function money(n){
      const num = Number(n || 0);
      return num.toLocaleString("es-CO");
    }

    function turnoLabel(t){
      if (t === "dia") return "Día";
      if (t === "noche") return "Noche";
      if (t === "mixto") return "Mixto";
      return t || "";
    }

    async function cargarVehiculos() {
      const sel = $("#vehiculo_id");
      sel.innerHTML = `<option value="">Cargando…</option>`;
      const res = await fetch(API.vehiculos);
      const json = await res.json();

      if (!json.ok) {
        sel.innerHTML = `<option value="">No se pudieron cargar</option>`;
        return;
      }

      const data = json.data || [];
      if (!data.length) {
        sel.innerHTML = `<option value="">No tienes vehículos registrados</option>`;
        return;
      }

      sel.innerHTML = `<option value="">Selecciona un vehículo…</option>`;
      data.forEach(v => {
        const id = v.id ?? v.vehiculo_id;
        const placa = v.placa ?? "SIN_PLACA";
        const modelo = v.modelo ?? "";
        const opt = document.createElement("option");
        opt.value = id;
        opt.textContent = `${placa} ${modelo}`.trim();
        sel.appendChild(opt);
      });
    }

    function validarPago() {
      const cuota = Number($("#cuota_diaria").value || 0);
      const pct = Number($("#porcentaje_propietario").value || 0);
      return cuota > 0 || pct > 0;
    }

    async function publicarOferta(e){
      e.preventDefault();

      if (!validarPago()) {
        alert("Debes ingresar Cuota diaria o % propietario (al menos uno).");
        return;
      }

      const data = {
        vehiculo_id: $("#vehiculo_id").value,
        ciudad: $("#ciudad").value.trim(),
        turno: $("#turno").value,
        estado: $("#estado").value,
        titulo: $("#titulo").value.trim(),
        descripcion: $("#descripcion").value.trim(),
        cuota_diaria: $("#cuota_diaria").value ? Number($("#cuota_diaria").value) : 0,
        porcentaje_propietario: $("#porcentaje_propietario").value ? Number($("#porcentaje_propietario").value) : 0,
        requisitos: $("#requisitos").value.trim(),
      };

      const btn = $("#btnPublicar");
      btn.disabled = true;

      try {
        const res = await fetch(API.crearOferta, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
        const json = await res.json();
        if (!json.ok) return alert(json.error || "Error al publicar");

        alert("Oferta publicada ✅");
        $("#formOferta").reset();
        await cargarMisOfertas();
      } catch (err) {
        console.error(err);
        alert("Error de red");
      } finally {
        btn.disabled = false;
      }
    }

    async function cargarMisOfertas(){
      const tbody = $("#tablaOfertas tbody");
      tbody.innerHTML = `<tr><td colspan="8" class="muted">Cargando…</td></tr>`;

      const res = await fetch(API.misOfertas);
      const json = await res.json();
      if (!json.ok) {
        tbody.innerHTML = `<tr><td colspan="8" class="muted">No se pudo cargar</td></tr>`;
        return;
      }

      const rows = json.data || [];
      if (!rows.length) {
        tbody.innerHTML = `<tr><td colspan="8" class="muted">Aún no tienes ofertas</td></tr>`;
        return;
      }

      tbody.innerHTML = "";
      rows.forEach(o => {
        const pagoTxt = (Number(o.cuota_diaria || 0) > 0)
          ? `$ ${money(o.cuota_diaria)} / día`
          : (Number(o.porcentaje_propietario || 0) > 0)
            ? `${o.porcentaje_propietario}% propietario`
            : "-";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${o.id}</td>
          <td>${(o.titulo || "").replaceAll("<","&lt;")}</td>
          <td>${o.ciudad || ""}</td>
          <td>${turnoLabel(o.turno)}</td>
          <td>${pagoTxt}</td>
          <td>
            <select data-action="estado" data-id="${o.idsizda}">
              <option value="activa" ${o.estado==="activa"?"selected":""}>activa</option>
              <option value="pausada" ${o.estado==="pausada"?"selected":""}>pausada</option>
              <option value="cerrada" ${o.estado==="cerrada"?"selected":""}>cerrada</option>
            </select>
          </td>
          <td>${Number(o.bloqueada||0) ? "Sí" : "No"}</td>
          <td>
            <button class="btn-ghost" data-action="eliminar" data-id="${o.id}" type="button">Eliminar</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function actualizarEstado(id, estado){
      const res = await fetch(API.actualizarOferta(id), {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ estado })
      });
      const json = await res.json();
      if (!json.ok) alert(json.error || "No se pudo actualizar");
    }

    async function eliminarOferta(id){
      if (!confirm("¿Eliminar oferta? (soft delete)")) return;
      const res = await fetch(API.eliminarOferta(id), { method: "DELETE" });
      const json = await res.json();
      if (!json.ok) return alert(json.error || "No se pudo eliminar");
      await cargarMisOfertas();
    }

    function bindTabla(){
      $("#tablaOfertas").addEventListener("change", async (e) => {
        const el = e.target;
        if (el?.dataset?.action === "estado") {
          await actualizarEstado(el.dataset.id, el.value);
        }
      });

      $("#tablaOfertas").addEventListener("click", async (e) => {
        const btn = e.target.closest("button");
        if (!btn) return;
        if (btn.dataset.action === "eliminar") await eliminarOferta(btn.dataset.id);
      });
    }

    $("#formOferta").addEventListener("submit", publicarOferta);
    $("#btnLimpiar").addEventListener("click", () => $("#formOferta").reset());
    $("#btnRefrescar").addEventListener("click", cargarMisOfertas);

    bindTabla();
    cargarVehiculos();
    cargarMisOfertas();
  </script>
</body>
</html>
